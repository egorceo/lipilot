const r={LLM_PROVIDER:"llm_provider",API_KEY:"openai_api_key",MODEL:"llm_model",PERSONA:"user_persona",HISTORY:"comment_history",ENABLE_EMOJIS:"enable_emojis",LANGUAGE_LEVEL:"language_level",ENABLE_IMAGE_ANALYSIS:"enable_image_analysis",SERVICE_DESCRIPTION:"service_description",FEEDBACK:"comment_feedback",PERSONA_OBSERVATIONS:"persona_observations"},l=10,m=20,E={llmProvider:"openai",apiKey:"",model:"gpt-4o-mini",persona:"",enableEmojis:!1,languageLevel:"fluent",enableImageAnalysis:!1,serviceDescription:""};function i(){var e;try{return!!((e=chrome==null?void 0:chrome.runtime)!=null&&e.id)}catch{return!1}}async function n(e,o){if(!i())return console.warn("Extension context invalidated. Please refresh the page."),o;try{return await e()}catch(a){if(a instanceof Error&&a.message.includes("Extension context invalidated"))return console.warn("Extension context invalidated. Please refresh the page."),o;throw a}}async function u(){return n(()=>new Promise(e=>{chrome.storage.local.get([r.LLM_PROVIDER,r.API_KEY,r.MODEL,r.PERSONA,r.ENABLE_EMOJIS,r.LANGUAGE_LEVEL,r.ENABLE_IMAGE_ANALYSIS,r.SERVICE_DESCRIPTION],o=>{if(chrome.runtime.lastError){console.warn("Storage error:",chrome.runtime.lastError),e(E);return}e({llmProvider:o[r.LLM_PROVIDER]||"openai",apiKey:o[r.API_KEY]||"",model:o[r.MODEL]||"gpt-4o-mini",persona:o[r.PERSONA]||"",enableEmojis:o[r.ENABLE_EMOJIS]??!1,languageLevel:o[r.LANGUAGE_LEVEL]||"fluent",enableImageAnalysis:o[r.ENABLE_IMAGE_ANALYSIS]??!1,serviceDescription:o[r.SERVICE_DESCRIPTION]||""})})}),E)}async function A(e){return n(()=>new Promise(o=>{chrome.storage.local.set({[r.LLM_PROVIDER]:e.llmProvider,[r.API_KEY]:e.apiKey,[r.MODEL]:e.model,[r.PERSONA]:e.persona,[r.ENABLE_EMOJIS]:e.enableEmojis,[r.LANGUAGE_LEVEL]:e.languageLevel,[r.ENABLE_IMAGE_ANALYSIS]:e.enableImageAnalysis,[r.SERVICE_DESCRIPTION]:e.serviceDescription},()=>{chrome.runtime.lastError&&console.warn("Storage error:",chrome.runtime.lastError),o()})}),void 0)}async function S(){return n(()=>new Promise(e=>{chrome.storage.local.get([r.PERSONA_OBSERVATIONS],o=>{if(chrome.runtime.lastError){console.warn("Storage error:",chrome.runtime.lastError),e([]);return}e(o[r.PERSONA_OBSERVATIONS]||[])})}),[])}async function O(e){if(!i())return;const o=await S(),s=[{text:e,timestamp:Date.now()},...o].slice(0,m);return n(()=>new Promise(t=>{chrome.storage.local.set({[r.PERSONA_OBSERVATIONS]:s},()=>{chrome.runtime.lastError&&console.warn("Storage error:",chrome.runtime.lastError),t()})}),void 0)}async function I(){return n(()=>new Promise(e=>{chrome.storage.local.remove([r.PERSONA_OBSERVATIONS],()=>{chrome.runtime.lastError&&console.warn("Storage error:",chrome.runtime.lastError),e()})}),void 0)}async function _(){return n(()=>new Promise(e=>{chrome.storage.local.get([r.HISTORY],o=>{if(chrome.runtime.lastError){console.warn("Storage error:",chrome.runtime.lastError),e([]);return}e(o[r.HISTORY]||[])})}),[])}async function g(e,o){if(!i()){console.warn("Extension context invalidated. Cannot save to history.");return}const a=await _(),t=[{id:Date.now().toString(),comment:e,postPreview:o.slice(0,100),timestamp:Date.now()},...a].slice(0,l);return n(()=>new Promise(c=>{chrome.storage.local.set({[r.HISTORY]:t},()=>{chrome.runtime.lastError&&console.warn("Storage error:",chrome.runtime.lastError),c()})}),void 0)}async function d(){return n(()=>new Promise(e=>{chrome.storage.local.remove([r.HISTORY],()=>{chrome.runtime.lastError&&console.warn("Storage error:",chrome.runtime.lastError),e()})}),void 0)}async function h(){return n(()=>new Promise(e=>{chrome.storage.local.get(["migration_v2_done"],o=>{if(o.migration_v2_done){e();return}chrome.storage.local.remove(["auth_token","server_url","use_backend","auth_step","auth_userEmail","extension_user_email","fullenrich_api_key"],()=>{chrome.storage.local.set({migration_v2_done:!0},()=>{console.log("[LiPilot] Migration from SaaS version completed"),e()})})})}),void 0)}export{S as a,_ as b,I as c,g as d,d as e,O as f,u as g,h as m,A as s};

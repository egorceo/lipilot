async function g(n,a,e,t){if(!a)return{content:"",success:!1,error:"API key not configured. Please add it in the extension settings."};try{switch(n){case"openai":return await h(a,e,t);case"anthropic":return await P(a,e,t);case"gemini":return await T(a,e,t);default:return{content:"",success:!1,error:`Unknown provider: ${n}`}}}catch(s){return console.error(`[LiPilot] ${n} API error:`,s),s instanceof TypeError&&s.message.includes("fetch")?{content:"",success:!1,error:"Network error. Please check your internet connection."}:{content:"",success:!1,error:s instanceof Error?s.message:"Failed to call LLM API"}}}async function h(n,a,e){var c,i,m;const t=[{role:"system",content:e.systemPrompt}];e.imageBase64&&e.imageMimeType?t.push({role:"user",content:[{type:"text",text:e.userPrompt},{type:"image_url",image_url:{url:`data:${e.imageMimeType};base64,${e.imageBase64}`,detail:"auto"}}]}):t.push({role:"user",content:e.userPrompt});const s={model:a,messages:t,temperature:e.temperature??.8,max_completion_tokens:e.maxTokens??1500};e.jsonMode&&(s.response_format={type:"json_object"});const o=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(s)});if(!o.ok)return u(o,"OpenAI");const r=(m=(i=(c=(await o.json()).choices)==null?void 0:c[0])==null?void 0:i.message)==null?void 0:m.content;return r?{content:r,success:!0}:{content:"",success:!1,error:"No response generated from OpenAI."}}async function P(n,a,e){var c,i;let t=e.systemPrompt;e.jsonMode&&(t+=`

IMPORTANT: You must respond with a valid JSON object. Do not include any text before or after the JSON.`);const s=[{type:"text",text:e.userPrompt}];e.imageBase64&&e.imageMimeType&&s.unshift({type:"image",source:{type:"base64",media_type:e.imageMimeType,data:e.imageBase64}});const o=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":n,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:a,system:t,messages:[{role:"user",content:s}],max_tokens:e.maxTokens??1500,temperature:e.temperature??.8})});if(!o.ok)return u(o,"Anthropic");const r=(i=(c=(await o.json()).content)==null?void 0:c[0])==null?void 0:i.text;return r?{content:r,success:!0}:{content:"",success:!1,error:"No response generated from Anthropic."}}async function T(n,a,e){var c,i,m,l,f,y,d;const t=[];e.imageBase64&&e.imageMimeType&&t.push({inlineData:{mimeType:e.imageMimeType,data:e.imageBase64}}),t.push({text:e.userPrompt});const s={temperature:e.temperature??.8,maxOutputTokens:e.maxTokens??1500};e.jsonMode&&(s.responseMimeType="application/json");const o=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${a}:generateContent?key=${n}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({systemInstruction:{parts:[{text:e.systemPrompt}]},contents:[{parts:t}],generationConfig:s})});if(!o.ok)return u(o,"Gemini");const p=await o.json(),r=(f=(l=(m=(i=(c=p.candidates)==null?void 0:c[0])==null?void 0:i.content)==null?void 0:m.parts)==null?void 0:l[0])==null?void 0:f.text;return r?{content:r,success:!0}:((d=(y=p.candidates)==null?void 0:y[0])==null?void 0:d.finishReason)==="SAFETY"?{content:"",success:!1,error:"Response blocked by Gemini safety filters. Try rephrasing."}:{content:"",success:!1,error:"No response generated from Gemini."}}async function u(n,a){var s,o;const e=await n.json().catch(()=>({})),t=((s=e.error)==null?void 0:s.message)||((o=e.error)==null?void 0:o.type)||`API request failed with status ${n.status}`;return n.status===401?{content:"",success:!1,error:`Invalid API key for ${a}. Please check your API key in settings.`}:n.status===429?{content:"",success:!1,error:"Rate limit exceeded. Please try again in a few moments."}:n.status===500||n.status===503?{content:"",success:!1,error:`${a} service is temporarily unavailable. Please try again.`}:{content:"",success:!1,error:t}}async function x(n,a,e){const t=await g(n,a,e,{systemPrompt:"You are a helpful assistant.",userPrompt:'Say "OK" and nothing else.',jsonMode:!1,temperature:0,maxTokens:10});return{success:t.success,error:t.error}}export{g as c,x as t};
